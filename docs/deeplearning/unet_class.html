

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>DL Land cover &#8212; Python coding for satellite image processing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/deeplearning/unet_class';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Crop Time series Xarray" href="ndvi_time_series.html" />
    <link rel="prev" title="GDAL programs" href="../gdal/gdal_misc.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    <span style="color:black;">Python for satellite image processing</span>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">INTRODUCTION</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../gdal/gdal_misc.html"><span style="color:black;">GDAL programs</span></a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#"><span style="color:black;">DL Land cover</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="ndvi_time_series.html"><span style="color:black;">Crop Time series Xarray</span></a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/vsmartins/gcersat/gh-pages?urlpath=lab/tree/docs/docs/deeplearning/unet_class.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/vsmartins/gcersat/blob/gh-pages/docs/docs/deeplearning/unet_class.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/vsmartins/gcersat" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/vsmartins/gcersat/issues/new?title=Issue%20on%20page%20%2Fdocs/deeplearning/unet_class.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/docs/deeplearning/unet_class.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1><span style="color:black;">DL Land cover</span></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-overview-span"><span style="color:black;">Overview</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-data-sources-span"><span style="color:black;">Data sources</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-loading-data-span"><span style="color:black;">Loading data</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-finding-files-span"><span style="color:black;">Finding files</span></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#merging-impervious-classes">Merging impervious classes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-train-test-val-splits">Creating train/test/val splits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-dataset-class">Creating a Dataset class</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#image-transforms-rotate-and-flip">Image Transforms (Rotate and Flip)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-all-together">Putting it all together</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-building">Model building</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-u-net">Defining U-Net</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-our-model">Testing our model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-the-model">Training the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-loss-function-focal-loss">Defining a loss function (focal loss)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#altering-weights-for-the-loss-function">Altering weights for the loss function</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperparameters-optimization-and-gpu-acceleration">Hyperparameters, optimization, and GPU acceleration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-dataloader-span"><span style="color:black;">DataLoader</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-evaluation-span"><span style="color:black;">Evaluation</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-metrics-span"><span style="color:black;">Metrics</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-confusion-matrix-span"><span style="color:black;">Confusion matrix</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-visual-analysis-span"><span style="color:black;">Visual analysis</span></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="span-style-color-black-dl-land-cover-span">
<h1><span style="color:black;">DL Land cover</span><a class="headerlink" href="#span-style-color-black-dl-land-cover-span" title="Permalink to this heading">#</a></h1>
<p>Developed by Dakota Hester</p>
<section id="span-style-color-black-overview-span">
<h2><span style="color:black;">Overview</span><a class="headerlink" href="#span-style-color-black-overview-span" title="Permalink to this heading">#</a></h2>
<p>Land cover classification at 1-meter spatial resolution using aerial imagery and deep learning</p>
<p>By Dakota Hester</p>
<p>Land cover classification is an important task in remote sensing: land cover maps are integral to monitoring the interaction between humans and the environment, as well as monitoring changes in natural resources. Land cover maps are typically created at medium spatial resolutions using remote sensing data from instruments aboard satellites (such as Landsat and Sentinel-2) that is processed by pixel-based machine learning algorithms. However, at high resolutions (&lt;5 meters), the effectiveness of pixel-based approaches to classification of remote sensing imagery tends to decrease due to increased intra-class variance and the prevalence of noise in the data. Deep learning approaches, on the other hand, use both spectral <em>and spatial</em> information when processing remote sensing data, alleviating some of the negative effects of aforementioned increased intra-class variance. This purpose of this tutorial is to provide a basic introduction for applying deep learning methods to remote sensing data. In particular, we will be training a modified U-Net semantic segmentation model to create an end-to-end approach to land cover classification.</p>
</section>
<section id="span-style-color-black-data-sources-span">
<h2><span style="color:black;">Data sources</span><a class="headerlink" href="#span-style-color-black-data-sources-span" title="Permalink to this heading">#</a></h2>
<p>In order to develop a deep learning model, we need a large source of labelled imagery for supervised training. The Chesapeake Bay land cover dataset is a 6 class 1-meter spatial resolution land cover dataset over the Chesapeake Bay watershed on the east coast of the United States. The labels in the target data correspond to the following land cover classes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1 = water
2 = tree canopy / forest
3 = low vegetation / field
4 = barren land
5 = impervious (other)
6 = impervious (road)
15 = no data (none in this dataset).
</pre></div>
</div>
<p>For our source imagery, we will use USDA NAIP 4-band (red, green, blue, NIR) aerial imagery resampled to 1-meter ground sampling distance (GSD). The Chesapeake LC dataset was created using NAIP, Landsat 8, NLCD, building footprint data, and road maps which is included in the full dataset. For simplicity’s sake, we will only use the NAIP data. <a class="reference external" href="https://www.chesapeakeconservancy.org/conservation-innovation-center/high-resolution-data/lulc-data-project-2022/">Follow this link for more information regarding the Chesapeake Bay LULC dataset.</a> Below is the extent of the full LULC dataset.</p>
<p><img alt="cb_extent" src="../../_images/CBLULC_extent.png" /></p>
<p>We will only be using a small subset of the dataset for this example. Specifically, the dataset consists of 10 NAIP scenes from the east coast of Virginia and their corresponding land cover annotations. Each scene has been sampled into a grid of 224x224 patches. The data is stored in the <code class="docutils literal notranslate"><span class="pre">./data</span></code> directory in this repository.</p>
</section>
<section id="span-style-color-black-loading-data-span">
<h2><span style="color:black;">Loading data</span><a class="headerlink" href="#span-style-color-black-loading-data-span" title="Permalink to this heading">#</a></h2>
<p>In order to load data from rasters into python, we need to use the <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> module. Below is an example of how to open and visualize a file using rasterio.</p>
<section id="span-style-color-black-finding-files-span">
<h3><span style="color:black;">Finding files</span><a class="headerlink" href="#span-style-color-black-finding-files-span" title="Permalink to this heading">#</a></h3>
<p>Before we can load files, we need to know where they are at. In this case, there is some NAIP data that has aleady been sampled stored in <code class="docutils literal notranslate"><span class="pre">./data</span></code> with the following directory structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">unet_data</span><span class="o">/</span>
<span class="o">||</span> <span class="n">NAIP_PATCH_ID</span><span class="o">/</span> 
<span class="o">|||</span> <span class="nb">input</span><span class="o">/</span>
<span class="o">||||</span> <span class="mf">00000.</span><span class="n">tif</span> <span class="p">(</span><span class="n">sample</span> <span class="kn">from</span> <span class="nn">corresponding</span> <span class="n">patch</span><span class="p">)</span>
<span class="o">||||</span> <span class="mf">00001.</span><span class="n">tif</span>
<span class="o">||||</span> <span class="mf">00002.</span><span class="n">tif</span>
<span class="o">||||</span> <span class="o">...</span>
<span class="o">|||</span> <span class="n">target</span><span class="o">/</span>
<span class="o">||||</span> <span class="mf">00000.</span><span class="n">tif</span> <span class="p">(</span><span class="n">sampl</span> <span class="kn">from</span> <span class="nn">corresponding</span> <span class="n">patch</span><span class="s1">&#39;s ground truth data)</span>
<span class="o">||||</span> <span class="mf">00001.</span><span class="n">tif</span>
<span class="o">||||</span> <span class="mf">00002.</span><span class="n">tif</span>
<span class="o">||||</span> <span class="o">...</span>
</pre></div>
</div>
<p>Knowing this, we can write a function that aggregates the NAIP data and their corresponding ground truth labels into a list of 2-tuples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">get_list_of_files</span><span class="p">(</span><span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\dataset\raster\unet_data&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Returns a list of tuples of the form (path_to_input_sample, path_to_label)</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    data_path (str): path to the root of the data directory</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    list[tuple[str, str]]: List of file paths with corresponding ground truth labels</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># get list of patch ids. list comprehension pretty much says &quot;look at the </span>
    <span class="c1"># items in the data_path directory and if they are directories, add them to </span>
    <span class="c1"># the list&quot;</span>
    <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patch_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_dir</span> <span class="k">for</span> <span class="n">sub_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">))]</span>
    
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patch_ids</span><span class="p">:</span>
        <span class="c1"># get all subsamples of each patch</span>
        <span class="n">subsamples</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span>
        <span class="c1"># add subsamples to file_path list</span>
        <span class="n">file_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">subsample</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">subsample</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">subsample</span> <span class="ow">in</span> <span class="n">subsamples</span>
        <span class="p">)</span>
        
    
    <span class="c1"># check to make sure files exist</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># if source file doesn&#39;t exist</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input file </span><span class="si">{</span><span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># if label file doesn&#39;t exist</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Label file </span><span class="si">{</span><span class="n">file_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">file_paths</span>
    
    
<span class="n">file_paths</span> <span class="o">=</span> <span class="n">get_list_of_files</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;D:\jupyterbooks\gcersat\dataset\raster\unet_data&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span> <span class="c1"># always a good idea to print out the number of files found</span>
<span class="nb">print</span><span class="p">(</span><span class="n">file_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># take a look at the first file path input/target 2-tupledataset/raster/unet_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Temp</span>\<span class="n">ipykernel_20836</span>\<span class="mf">1356497114.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="k">def</span> <span class="nf">get_list_of_files</span><span class="p">(</span><span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\dataset\raster\unet_data&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="s1">&#39;&#39;&#39;Returns a list of tuples of the form (path_to_input_sample, path_to_label)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span><span class="s1"> </span>
<span class="g g-Whitespace">      </span><span class="mi">5</span><span class="s1">     Parameters:</span>

<span class="ne">TypeError</span>: &#39;type&#39; object is not subscriptable
</pre></div>
</div>
</div>
</div>
<p>Now, lets look through our files and visualize the data to make sure that we have the right data and that we are loading it into Python correctly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">rasterio.plot</span> <span class="kn">import</span> <span class="n">show</span>

<span class="n">src_file</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># first sample, only the input data</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span> <span class="c1"># grab geo metadata</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="c1"># grab raster data (as numpy array)</span>
    <span class="n">red_band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># only grab red band (as numpy array)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;raster metadata:&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;raster shape:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;red band raster shape:&#39;</span><span class="p">,</span> <span class="n">red_band</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">data_rgb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># create RGB image</span>
<span class="n">show</span><span class="p">(</span><span class="n">data_rgb</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
<span class="n">data_cir</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="c1"># grab only the G R NIR bands</span>
<span class="n">show</span><span class="p">(</span><span class="n">data_cir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CIR&#39;</span><span class="p">)</span>

<span class="n">target_file</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># first sample, only the target data</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">target_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span> <span class="c1"># grab geo metadata</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="c1"># grab raster data (as numpy array)</span>
    
<span class="n">show</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">target_meta</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>raster metadata: {&#39;driver&#39;: &#39;GTiff&#39;, &#39;dtype&#39;: &#39;uint8&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 224, &#39;height&#39;: 224, &#39;count&#39;: 4, &#39;crs&#39;: CRS.from_epsg(26918), &#39;transform&#39;: Affine(1.0, 0.0, 413351.0,
       0.0, -1.0, 4055221.0)}
raster shape: (4, 224, 224)
red band raster shape: (224, 224)
</pre></div>
</div>
<img alt="../../_images/8e23c97c573a745facf76a23f1fd2ccfc959c5bdbdebd2aa9f8b79ba78a294b0.png" src="../../_images/8e23c97c573a745facf76a23f1fd2ccfc959c5bdbdebd2aa9f8b79ba78a294b0.png" />
<img alt="../../_images/10e0b145c31f35d93122f1f586b7dd08bb761f9924fb1d1b407deb0c1deabe86.png" src="../../_images/10e0b145c31f35d93122f1f586b7dd08bb761f9924fb1d1b407deb0c1deabe86.png" />
<img alt="../../_images/996023ea2df4d41bd00ea8eb0cb89e9896d7404743bc78e3f95b0337b37fea14.png" src="../../_images/996023ea2df4d41bd00ea8eb0cb89e9896d7404743bc78e3f95b0337b37fea14.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: title={&#39;center&#39;: &#39;Target&#39;}&gt;
</pre></div>
</div>
</div>
</div>
<p>In order to make our life easier down the line, let’s go ahead and create a few helper functions for working with raster data. First, let’s create a function that prints the shape (dimensionality) of an array, along with other important properties.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_array_info</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;array shape:&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;array dtype:&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;array range:&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
<span class="n">print_array_info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">print_array_info</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array shape: (4, 224, 224)
array dtype: uint8
array range: 27 165
array shape: (1, 224, 224)
array dtype: uint8
array range: 1 1
</pre></div>
</div>
</div>
</div>
<p>Now, let’s create functions for vizualizing raster and label data easily.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">visualize_raster</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">raster</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># create RGB image</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">raster</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="c1"># grab only the G R NIR bands</span>
    
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># convert from (bands, rows, cols) to (rows, cols, bands)</span>
    <span class="n">cir</span> <span class="o">=</span> <span class="n">cir</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># create plt figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># plot RGB image</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="c1"># plot CIR image</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cir</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CIR&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span> <span class="c1"># formatting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="n">visualize_raster</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;test raster&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1089d1d5ab36137929aad9ecc515b77a1415dc3ce58ff579cf7915562e019c39.png" src="../../_images/1089d1d5ab36137929aad9ecc515b77a1415dc3ce58ff579cf7915562e019c39.png" />
</div>
</div>
<p>When creating maps from land cover data, often it is convenient to create a color profile that corresponds to the legend elements instead of using a standard color map. As a refresher - here are the land cover classes we are working with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1 = water
2 = tree canopy / forest
3 = low vegetation / field
4 = barren land
5 = impervious (other)
6 = impervious (road)
15 = no data.
</pre></div>
</div>
<p>Thankfully, <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> provides an easy interface for creating a custom color map using the <code class="docutils literal notranslate"><span class="pre">ListedColorMap</span></code> class, and an interface for customizing legend entries with the corresponding colors using the <code class="docutils literal notranslate"><span class="pre">Patch</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Patch</span>

<span class="n">land_cover_colors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="c1"># 1 - water</span>
    <span class="s1">&#39;darkgreen&#39;</span><span class="p">,</span> <span class="c1"># 2 - tree canopy/forest</span>
    <span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="c1"># 3 - low vegetation/field</span>
    <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="c1"># 4 - barren land</span>
    <span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="c1"># 5 - impervious (other)</span>
    <span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="c1"># 6 - impervious (road)</span>
<span class="p">]</span> <span class="c1"># no nodata samples in our dataset, so no need to add a nodata color</span>

<span class="n">land_cover_labels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Water&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tree Canopy/Forest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Low Vegetation/Field&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Barren Land&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Impervious (Other)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Impervious (Road)&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">land_cover_cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">land_cover_colors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;land-cover&#39;</span><span class="p">)</span> <span class="c1"># create color map object</span>
<span class="n">land_cover_legend</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">land_cover_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">land_cover_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">land_cover_colors</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">land_cover_colors</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
    <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">land_cover_colors</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
    <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">land_cover_colors</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">visualize_target</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># remove extra dimension if necessary</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">land_cover_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1"># plot target image</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">land_cover_legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># add legend</span>
    
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="mi">1</span><span class="c1"># subtract 1 from all values to make the range 0-6 instead of 1-7</span>
<span class="n">visualize_target</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;Test target&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/225f652c5df25c8d6a61a8a4504e2a36d81aaa961a3f285da44c11a2f8de3d3b.png" src="../../_images/225f652c5df25c8d6a61a8a4504e2a36d81aaa961a3f285da44c11a2f8de3d3b.png" />
</div>
</div>
<p>Finally, let’s create one more function that plots the class distribution of a dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_class_distributuion</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">class_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># get counts of each class</span>
    <span class="n">class_dist</span> <span class="o">=</span> <span class="n">class_dist</span> <span class="o">/</span> <span class="n">class_dist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># standardize to sum to 1</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_dist</span><span class="p">)),</span> <span class="n">class_dist</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_dist</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">land_cover_labels</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Samples&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class Distribution: n_samples = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">class_dist</span>

<span class="c1"># # load all target data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">target_file</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># subtract 1 from all values to make the range 0-6 instead of 1-7</span>

<span class="c1"># plot class distribution</span>
<span class="n">y_class_dist</span> <span class="o">=</span> <span class="n">plot_class_distributuion</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0ad7a32baece5ec606366e9cded918b9775f6a201421d3ce92a0c586faa41234.png" src="../../_images/0ad7a32baece5ec606366e9cded918b9775f6a201421d3ce92a0c586faa41234.png" />
</div>
</div>
<p>This dataset is <em>very</em> imbalanced. There are barely any barren land pixels in the labels, and water/forest/vegetation classes dominate the dataset. In order to tackle this, we will merge the impervious classes into one class and adjust the loss function to overemphasize underrepresented samples.</p>
<section id="merging-impervious-classes">
<h4>Merging impervious classes<a class="headerlink" href="#merging-impervious-classes" title="Permalink to this heading">#</a></h4>
<p>If you take a look at the samples in the dataset that contain impervious structures, you’ll notice quite a bit of misclassification between roads and other impervious structures. This dataset used an external road database to aid in the classification of impervious structures. However, because we are not working with such data, and the dataset’s annotations are spotty between the two classes, we can justify merging the two classes into a single “impervious” class</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_idxs_with_impervious</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="mi">4</span> <span class="ow">in</span> <span class="n">sample</span> <span class="ow">and</span> <span class="mi">5</span> <span class="ow">in</span> <span class="n">sample</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">label_to_viz</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">sample_idxs_with_impervious</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">visualize_target</span><span class="p">(</span><span class="n">label_to_viz</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Confusion of Impervious Classes&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4d98a4548d4c91b40d75316281284a2099e4e09efdf266c30316fbcd72a58082.png" src="../../_images/4d98a4548d4c91b40d75316281284a2099e4e09efdf266c30316fbcd72a58082.png" />
<img alt="../../_images/9dc1dc73e7c88506afa3ec2d1f30d085f88d9bdea7511185e624c9b38273bec5.png" src="../../_images/9dc1dc73e7c88506afa3ec2d1f30d085f88d9bdea7511185e624c9b38273bec5.png" />
<img alt="../../_images/5a371953a91bd666730cc3723b1f8ffbd74690561d68018f5bd429f6f5a0855d.png" src="../../_images/5a371953a91bd666730cc3723b1f8ffbd74690561d68018f5bd429f6f5a0855d.png" />
<img alt="../../_images/008bb50d45a44f534ad858ccfabb099973a428b6bab35b3bc4085e319fdcfbbf.png" src="../../_images/008bb50d45a44f534ad858ccfabb099973a428b6bab35b3bc4085e319fdcfbbf.png" />
<img alt="../../_images/b1813ad080c2b57c3dec7ca55017066812b2376386ba3e640d4b2fc43212b241.png" src="../../_images/b1813ad080c2b57c3dec7ca55017066812b2376386ba3e640d4b2fc43212b241.png" />
</div>
</div>
<p>Let’s define a function that merges the two classes, then adjust the land cover legend to reflect those changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">merge_impervious_classes</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="n">label</span><span class="p">[</span><span class="n">label</span> <span class="o">==</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">return</span> <span class="n">label</span>

<span class="n">land_cover_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># remove impervious (road) from labels</span>
<span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Impervious&#39;</span> <span class="c1"># rename impervious (other) to just impervious</span>
<span class="n">land_cover_legend</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># remove impervious (road) from legend (for plotting)</span>
<span class="n">land_cover_legend</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">land_cover_labels</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># rename impervious (other) to just impervious (for plotting)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">label_to_viz</span> <span class="o">=</span> <span class="n">merge_impervious_classes</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">sample_idxs_with_impervious</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">visualize_target</span><span class="p">(</span><span class="n">label_to_viz</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Merged Impervious Classes&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cb1e2389f711ce3207f6698663bd74a0df74259a3ca2106f7f92d5623b4a603e.png" src="../../_images/cb1e2389f711ce3207f6698663bd74a0df74259a3ca2106f7f92d5623b4a603e.png" />
<img alt="../../_images/0db7a56b0b156df07e0ce7a6d6f7cf90c0b1605837a4fc3f6f3f4d4f3f50a120.png" src="../../_images/0db7a56b0b156df07e0ce7a6d6f7cf90c0b1605837a4fc3f6f3f4d4f3f50a120.png" />
<img alt="../../_images/05cfc1b6b6e02db2555aca49f8a0fe1be7c25b2229842052ced7d02c5691d596.png" src="../../_images/05cfc1b6b6e02db2555aca49f8a0fe1be7c25b2229842052ced7d02c5691d596.png" />
<img alt="../../_images/665feff40cef88ae2fef3cbafb64b659a409d8b7f9fdf5b92e90c032e68677c8.png" src="../../_images/665feff40cef88ae2fef3cbafb64b659a409d8b7f9fdf5b92e90c032e68677c8.png" />
<img alt="../../_images/c4a3b39f3a6289aa6de1d5ecbdd2f9ff4a215cf4185f6ca88e991dc770a2a7ff.png" src="../../_images/c4a3b39f3a6289aa6de1d5ecbdd2f9ff4a215cf4185f6ca88e991dc770a2a7ff.png" />
</div>
</div>
</section>
</section>
<section id="creating-train-test-val-splits">
<h3>Creating train/test/val splits<a class="headerlink" href="#creating-train-test-val-splits" title="Permalink to this heading">#</a></h3>
<p>When training a deep learning model, we need at least 2 different dataset splits: a training split which consists of samples the models will train with, and a holdout set with samples that the model will not use during training. Additionally, it is also a good idea to create a validation set that is similar in size to the test split that will be used after each epoch is training is completed to determine how well the model can generalize to unseen data. If the loss calculated on the validation set is significantly greater than that of the training dataset, then our model is <em>overfitting</em>. Backpropogation is <em>not</em> performed on the validation or test splits meaning they have no impact on the parameters or performance of the model - these splits exist purely for evaluation purposes.</p>
<p>In this example, we are simply going to randomly choose samples to go in each split. Typically 20% of the dataset is placed in the test and validation splits respectively, whereas the remaining 60% is placed in the validation split.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1701</span><span class="p">)</span> <span class="c1"># set random seed for reproducibility</span>

<span class="n">n_total_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span>
<span class="n">n_test_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_total_samples</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span> <span class="c1"># 20% of data will be used for testing</span>
<span class="n">n_val_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_total_samples</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span> <span class="c1"># 20% of data will be used for validation</span>
<span class="n">n_train_samples</span> <span class="o">=</span> <span class="n">n_total_samples</span> <span class="o">-</span> <span class="n">n_test_samples</span> <span class="o">-</span> <span class="n">n_val_samples</span> <span class="c1"># the rest of the data will be used for training</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total samples: </span><span class="si">{</span><span class="n">n_total_samples</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train samples: </span><span class="si">{</span><span class="n">n_train_samples</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation samples: </span><span class="si">{</span><span class="n">n_val_samples</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test samples: </span><span class="si">{</span><span class="n">n_test_samples</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># shuffle the file paths (in-place operation)</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span>

<span class="c1"># split file paths into train, test, and validation sets</span>
<span class="n">train_file_paths</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[:</span><span class="n">n_train_samples</span><span class="p">]</span>
<span class="n">val_file_paths</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="n">n_train_samples</span><span class="p">:</span><span class="n">n_train_samples</span><span class="o">+</span><span class="n">n_val_samples</span><span class="p">]</span>
<span class="n">test_file_paths</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="n">n_train_samples</span><span class="o">+</span><span class="n">n_val_samples</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total samples: 6160
Train samples: 3696
Validation samples: 1232
Test samples: 1232
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">train_file_paths</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># subtract 1 from all values to make the range 0-6 instead of 1-7</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">merge_impervious_classes</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">])</span> <span class="c1"># merge impervious classes</span>

<span class="n">class_dist</span> <span class="o">=</span> <span class="n">plot_class_distributuion</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="c1"># look at class distribution</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/98bd9f135a2468af85b46e95eeac5a2eccc9485ad8f83d0ecb67cdd8f76949bc.png" src="../../_images/98bd9f135a2468af85b46e95eeac5a2eccc9485ad8f83d0ecb67cdd8f76949bc.png" />
</div>
</div>
</section>
<section id="creating-a-dataset-class">
<h3>Creating a Dataset class<a class="headerlink" href="#creating-a-dataset-class" title="Permalink to this heading">#</a></h3>
<p>In order to load data to train a neural network model in PyTorch, we need to create a custom class that tells PyTorch <em>how</em> to load each sample into memory, and what transformations need to be performed on each sample. If you’re unfamiliar with this practice, you may not immediately see the value in it compared to simply using a list of samples or <code class="docutils literal notranslate"><span class="pre">numpy</span></code> arrays. Indeed, it may seem like more unnecessary boiler-plate code, but there are several important reasons why creating a custom <code class="docutils literal notranslate"><span class="pre">torch.utils.data.Dataset</span></code> class has its advantages:</p>
<ol class="arabic simple">
<li><p>Subclassing <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> gives us near complete control on how data is loaded and passed to the model. For small, simple datasets it often more than enough to use a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array to load samples for training. However, when working with large, complicated datasets, we often need to load samples directly from the disk on the fly and transform them to be suitable for training. Using the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method gives us near-unlimited options with regards to the type of data we need to load, how that data is stored (memory, disk, network, etc.), and any transforms/pre-processing that needs to be performed on the data.</p></li>
<li><p>Using the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class allows us to unlock the powerful features of object-oriented programming. We can store important information about the dataset - such as the distribution of classes, means, standard deviations, metadata, and more and access them easily, from both within the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class definition and the object itself. As such, your dataset can have all sorts of useful properties outside of just the data. In the following example, we can have the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method of our <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class return the metadata of the sample - allowing us to easily save rasters with geospatial information on-the-fly during inference - but we’ll save that for another day.</p></li>
</ol>
<p>In the following example, we will subclass <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> to create a new <code class="docutils literal notranslate"><span class="pre">NAIP_Dataset</span></code> class with functions specific to raster data. Notably, we will load rasters into memory as they are requested instead of loading the entire dataset into memory. Pay extra attention to the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method in the following class definition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="c1"># our custom NAIP_Dataset class will inherit from the Dataset class</span>
<span class="k">class</span> <span class="nc">NAIP_Dataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path_list</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span> <span class="c1"># more on this later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_dist</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># we will use this later</span>
        
        <span class="c1"># min and max values of the NAIP imagery (per bands)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path_list</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mins</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mins</span>
        
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path_list</span><span class="p">)</span>
    
    <span class="c1"># __getitem__() is called when indexed in the form dataset[i]</span>
    <span class="c1"># typically a __getitem__() method returns a single sample from the dataset</span>
    <span class="c1"># in the form of a tuple: (X, y) where X is the data fed into</span>
    <span class="c1"># the model and y is the ground truch label associated with the data.</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="c1"># get file path to laod</span>
        
        <span class="c1"># load raster data to memory</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="c1"># convert to torch tensors</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span> <span class="c1"># convert to float tensor</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span> <span class="c1"># convert to float tensor</span>
        
        <span class="c1"># standardize input data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mins</span><span class="p">)</span> <span class="c1"># subtract min</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">)</span> <span class="c1"># divide by range</span>
        
        <span class="c1"># subtract 1 from labels so that classes are indexed from 0 to 6 (instead of 1 to 7)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="c1"># merge impervious classes</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">merge_impervious_classes</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># image transformations (more on this later)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
    
    <span class="c1"># NOTE: we can add additional methods to our custom dataset class to make our</span>
    <span class="c1"># lives easier. For example, let&#39;s create a method that returns the class distribution</span>
    <span class="c1"># of the dataset</span>
    
    <span class="k">def</span> <span class="nf">get_class_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_dist</span> <span class="c1"># return cached result if available</span>
        
        <span class="c1"># load all labels into memory (as numpy array)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path_list</span><span class="p">])</span>
        
        <span class="c1"># subtract 1 from labels so that classes are indexed from 0 to 6 (instead of 1 to 7)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">merge_impervious_classes</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="c1"># merge impervious classes</span>
        
        <span class="c1"># get class distribution using numpy histogram function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_dist</span>

    <span class="k">def</span> <span class="nf">plot_class_distributuion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        
        <span class="n">class_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_class_distribution</span><span class="p">()</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_dist</span><span class="p">)),</span> <span class="n">class_dist</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_dist</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">land_cover_labels</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Samples&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class Distribution: n_samples = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">class_dist</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we’ll test out our <code class="docutils literal notranslate"><span class="pre">NAIP_Dataset</span></code> class using a subset of the original dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subset_files</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="c1"># select first 5 samples of full dataset for subset</span>

<span class="n">subset_dataset</span> <span class="o">=</span> <span class="n">NAIP_Dataset</span><span class="p">(</span><span class="n">subset_files</span><span class="p">)</span> <span class="c1"># create dataset object</span>

<span class="c1"># since the __getitem__ method has been overridden, we can access samples in the </span>
<span class="c1"># dataset using the indexing operator [], similar to how we would index a list</span>
<span class="n">X_temp</span><span class="p">,</span> <span class="n">y_temp</span> <span class="o">=</span> <span class="n">subset_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get first sample in dataset</span>
<span class="n">print_array_info</span><span class="p">(</span><span class="n">X_temp</span><span class="p">)</span> <span class="c1"># NOTE: because X and y are torch tensors, the output will vary sligtly from previous examples</span>
<span class="n">print_array_info</span><span class="p">(</span><span class="n">y_temp</span><span class="p">)</span>

<span class="n">visualize_raster</span><span class="p">(</span><span class="n">X_temp</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s1">&#39;Subset sample&#39;</span><span class="p">)</span>
<span class="n">visualize_target</span><span class="p">(</span><span class="n">y_temp</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s1">&#39;Subset sample&#39;</span><span class="p">)</span>

<span class="c1"># check how many samples are in the dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of samples in dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subset_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># __len__ method has been overriden</span>

<span class="c1"># check class distribution</span>
<span class="n">subset_dataset</span><span class="o">.</span><span class="n">plot_class_distributuion</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array shape: torch.Size([4, 224, 224])
array dtype: torch.float32
array range: tensor(0.) tensor(0.9695)
array shape: torch.Size([1, 224, 224])
array dtype: torch.float32
array range: tensor(1.) tensor(1.)
</pre></div>
</div>
<img alt="../../_images/d022108abe8c8a6e0d00addd997fee0d62f0201a15e36658500b93e71aa8fedf.png" src="../../_images/d022108abe8c8a6e0d00addd997fee0d62f0201a15e36658500b93e71aa8fedf.png" />
<img alt="../../_images/7851e7880d81c895b85a9aec57747ef186c53199b4def379ba32fe95dae7b3cc.png" src="../../_images/7851e7880d81c895b85a9aec57747ef186c53199b4def379ba32fe95dae7b3cc.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of samples in dataset: 5
</pre></div>
</div>
<img alt="../../_images/781fe6423548d95279f55788b8e9f45edb3caf7b9af1af7c1dca6c20760896ef.png" src="../../_images/781fe6423548d95279f55788b8e9f45edb3caf7b9af1af7c1dca6c20760896ef.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.24408582, 0.88095404, 0.11646006, 0.        , 0.00850008])
</pre></div>
</div>
</div>
</div>
<section id="image-transforms-rotate-and-flip">
<h4>Image Transforms (Rotate and Flip)<a class="headerlink" href="#image-transforms-rotate-and-flip" title="Permalink to this heading">#</a></h4>
<p>When training a deep learning model for image tasks we need to use as many training samples as possible. One widely-used method for artificially boosting the number of training samples seen by a model during training is data augmentation. Under data augmentation, we randomly apply a series of image transformations to each sample of training data before being passing it to the model during the training phase. Some examples of popular augmentation techniques include</p>
<ul class="simple">
<li><p>Resizing</p></li>
<li><p>Cropping</p></li>
<li><p>Contrast adjustment</p></li>
<li><p>Color adjustment</p></li>
<li><p>Pixel jitter (shift the value of each pixel slightly)</p></li>
<li><p>Rotation</p></li>
<li><p>Flip (vertical and horizontal).</p></li>
</ul>
<p>By augmenting data before training, we try to ensure that the model does not overfit on the dataset. When the model is overfit, the model captures features in the training data too well, leading to poor generalization on other data - significantly reducing the performance of the model on data it has not been trained on. Here, we will define a simple transform class that randomly rotates a sample by a multiple of 90 degrees as well as applying random flips.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision.transforms.functional</span> <span class="kn">import</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">hflip</span><span class="p">,</span> <span class="n">vflip</span>

<span class="k">class</span> <span class="nc">RotateAndFlipTransforms</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">]</span> <span class="c1"># possible angles to rotate (0 and 360 are the same as the original)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_rotate</span> <span class="o">=</span> <span class="mf">0.75</span> <span class="c1"># probability of rotating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_flip</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># probability of flipping</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        
        <span class="c1"># rotate with probability p_rotate</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_rotate</span><span class="p">:</span> 
            <span class="n">angle</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span> <span class="c1"># if rotating, choose a random angle</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

        <span class="c1"># horizontal flip with probability p_flip</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_flip</span><span class="p">:</span> <span class="c1"># horizontal flip with probability p_flip</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">hflip</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">hflip</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            
        <span class="c1"># vertical flip with probability p_flip</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_flip</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">vflip</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">vflip</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="n">transform</span> <span class="o">=</span> <span class="n">RotateAndFlipTransforms</span><span class="p">()</span>

<span class="c1"># testing the transform</span>
<span class="n">X_temp_aug</span><span class="p">,</span> <span class="n">y_temp_aug</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">X_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">)</span>

<span class="c1"># print array info</span>
<span class="n">print_array_info</span><span class="p">(</span><span class="n">X_temp_aug</span><span class="p">)</span>
<span class="n">print_array_info</span><span class="p">(</span><span class="n">y_temp_aug</span><span class="p">)</span>

<span class="c1"># visualize transformed data</span>
<span class="c1"># NOTE: should convert torch tensors to numpy arrays before visualizing</span>
<span class="n">visualize_raster</span><span class="p">(</span><span class="n">X_temp</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Original raster&#39;</span><span class="p">)</span>
<span class="n">visualize_raster</span><span class="p">(</span><span class="n">X_temp_aug</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Transformed raster&#39;</span><span class="p">)</span>
<span class="n">visualize_target</span><span class="p">(</span><span class="n">y_temp</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Original target&#39;</span><span class="p">)</span>
<span class="n">visualize_target</span><span class="p">(</span><span class="n">y_temp_aug</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Transformed target&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array shape: torch.Size([4, 224, 224])
array dtype: torch.float32
array range: tensor(0.) tensor(0.9695)
array shape: torch.Size([1, 224, 224])
array dtype: torch.float32
array range: tensor(1.) tensor(1.)
</pre></div>
</div>
<img alt="../../_images/1236d4e185e8004e88d73a3ed80618a624086dbd0edc4a53ad8f5d5747526702.png" src="../../_images/1236d4e185e8004e88d73a3ed80618a624086dbd0edc4a53ad8f5d5747526702.png" />
<img alt="../../_images/ef57b18ee1b786ed510f97ffc6f845d8ff26f5271bd6a59796ff6dc80320d5ce.png" src="../../_images/ef57b18ee1b786ed510f97ffc6f845d8ff26f5271bd6a59796ff6dc80320d5ce.png" />
<img alt="../../_images/fc7f641b3bb9982155102a185b8093c5cd9c6d2e897c1af35c4eb5998f5d6a22.png" src="../../_images/fc7f641b3bb9982155102a185b8093c5cd9c6d2e897c1af35c4eb5998f5d6a22.png" />
<img alt="../../_images/27a540ed5b9b797eae7e0a2f58ca828f2053f42cba70e6a36c7f089242997987.png" src="../../_images/27a540ed5b9b797eae7e0a2f58ca828f2053f42cba70e6a36c7f089242997987.png" />
</div>
</div>
</section>
</section>
<section id="putting-it-all-together">
<h3>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this heading">#</a></h3>
<p>Now that we have the <code class="docutils literal notranslate"><span class="pre">NAIP_Dataset</span></code> class defined, we can put everything together and create three datasets: a test, validation, and train dataset. First, we need to create a <code class="docutils literal notranslate"><span class="pre">RotateAndFlipTransforms</span></code> object, then simply create three new <code class="docutils literal notranslate"><span class="pre">NAIP_Dataset</span></code> objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">NAIP_Dataset</span><span class="p">(</span><span class="n">train_file_paths</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">RotateAndFlipTransforms</span><span class="p">())</span> 
<span class="n">train_class_dist</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_class_distribution</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Class distribution for training set:&#39;</span><span class="p">,</span> <span class="n">train_class_dist</span><span class="p">)</span>

<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">NAIP_Dataset</span><span class="p">(</span><span class="n">val_file_paths</span><span class="p">)</span> <span class="c1"># no need for transforms on validation/test sets</span>
<span class="n">val_class_dist</span> <span class="o">=</span> <span class="n">val_dataset</span><span class="o">.</span><span class="n">get_class_distribution</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Class distribution for validation set:&#39;</span><span class="p">,</span> <span class="n">val_class_dist</span><span class="p">)</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">NAIP_Dataset</span><span class="p">(</span><span class="n">test_file_paths</span><span class="p">)</span>
<span class="n">test_class_dist</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">get_class_distribution</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Class distribution for test set:&#39;</span><span class="p">,</span> <span class="n">test_class_dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Class distribution for training set: [0.23125458 0.61486403 0.38085044 0.00072105 0.02230991]
Class distribution for validation set: [2.23757079e-01 6.17434342e-01 3.87639769e-01 5.63034353e-04
 2.06057753e-02]
Class distribution for test set: [2.23006232e-01 6.13281165e-01 3.91751534e-01 5.47302392e-04
 2.14137672e-02]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="model-building">
<h2>Model building<a class="headerlink" href="#model-building" title="Permalink to this heading">#</a></h2>
<p>Now that we have a means of loading and visualizing data, we can start working on defining the model and it’s behavior. We will define the model and the loss function using the <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> object-oriented API. This allows us to create a highly flexible and configurable model/loss.</p>
<section id="defining-u-net">
<h3>Defining U-Net<a class="headerlink" href="#defining-u-net" title="Permalink to this heading">#</a></h3>
<p>U-Net is a popular deep learning semantic segmentation architecture that uses convolutional layers to <em>encode</em> spatial features in an image to a lower dimensional feature space, then <em>decodes</em> the latent space to produce a final segmentation map. During inference, the outputs from each encoder layer are passed to the corresponding decoder layer in the decoder. U-Net was originally developed for binary segmentation of biomedical imagery, but is widely used in many disciplines that frequently deal with image-like data due to its simplicity and effectiveness.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># code is modified from https://github.com/milesial/Pytorch-UNet</span>
<span class="c1"># in order to comply with GPLv3, link to original code is provided above and </span>
<span class="c1"># GPL v3 license is included in the repository</span>

<span class="sd">&quot;&quot;&quot; Parts of the U-Net model &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="k">class</span> <span class="nc">DoubleConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;(convolution =&gt; [BN] =&gt; ReLU) * 2&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">mid_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DoubleConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mid_channels</span><span class="p">:</span>
            <span class="n">mid_channels</span> <span class="o">=</span> <span class="n">out_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">double_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">mid_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">mid_channels</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mid_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">double_conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Down</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Downscaling with maxpool then double conv&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Down</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">DoubleConv</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool_conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Up</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upscaling then double conv&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span> <span class="c1"># remove bilinear option</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Up</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="c1"># input is CHW</span>
        <span class="n">diffY</span> <span class="o">=</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">diffX</span> <span class="o">=</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">x1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">diffX</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">diffX</span> <span class="o">-</span> <span class="n">diffX</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">diffY</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">diffY</span> <span class="o">-</span> <span class="n">diffY</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
        <span class="c1"># if you have padding issues, see</span>
        <span class="c1"># https://github.com/HaiyongJiang/U-Net-Pytorch-Unstructured-Buggy/commit/0e854509c2cea854e247a9c615f175f76fbb2e3a</span>
        <span class="c1"># https://github.com/xiaopeng-liao/Pytorch-UNet/commit/8ebac70e633bac59fc22bb5195e513d5832fb3bd</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">OutConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OutConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot; Full assembly of the parts to form the complete network &quot;&quot;&quot;</span>
<span class="k">class</span> <span class="nc">UNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">n_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="n">n_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        
        <span class="c1"># need to use nn.ModuleList since encoder and decoder are lists of nn.Modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([(</span><span class="n">DoubleConv</span><span class="p">(</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]))])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Down</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Up</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">outc</span> <span class="o">=</span> <span class="p">(</span><span class="n">OutConv</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_classes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        
        <span class="n">encoder_layer_outputs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># need to store outputs from each layer in the encoder</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoder_layer_outputs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># don&#39;t save output from last encoder layer</span>
                <span class="n">encoder_layer_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="c1"># pass output from each encoder layer to corresponding decoder layer</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">encoder_layer_outputs</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span> <span class="c1"># pass output from corresponding encoder layer</span>
        
        <span class="c1"># final convolutional layer</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="testing-our-model">
<h3>Testing our model<a class="headerlink" href="#testing-our-model" title="Permalink to this heading">#</a></h3>
<p>Now that the model has been defined, it is a good idea to test it by creating a random input and passing it through the model. We do this to make sure the inputs and outputs match the dimensions of our dataset. In this case, our input is four-band imagery at 224x224 resolution, and our output should match the input resolution with 6 channels (one channel for each class).</p>
<p>Note that from now on, we will be primarily working with <em>torch tensors</em> instead of numpy arrays. A tensor is very similar to numpy array, but has special methods and attributes specifically designed for deep learning applications. For example, tensors can be placed in main memory (CPU), or on the GPU for increased performance during training and inference. Also note that Pytorch models expect inputs to have 4 dimensions. The first dimension refers to the batch size (i.e., we stack 16 tensors of shape (4, 224, 224) on top of each other to get a tensor with shape (16, 4, 224, 224)). The second dimension refers to the number of channels in the input data. Typically, when working with RGB imagery, only 3 input channels are needed. In our case, we are using 4-band data, so our model needs four input channels. The final two dimensions refer to the height and width of the input data, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">UNet</span><span class="p">(</span><span class="n">n_channels</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># create mode</span>

<span class="n">test_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="c1"># create a random input sample (dummy)</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span> <span class="c1"># feed the input sample to the model</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">test_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># print the output shape</span>
<span class="k">assert</span> <span class="n">test_y</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="c1"># make sure the output shape is correct</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Output shape: torch.Size([1, 5, 256, 256])
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="training-the-model">
<h2>Training the model<a class="headerlink" href="#training-the-model" title="Permalink to this heading">#</a></h2>
<section id="defining-a-loss-function-focal-loss">
<h3>Defining a loss function (focal loss)<a class="headerlink" href="#defining-a-loss-function-focal-loss" title="Permalink to this heading">#</a></h3>
<p>Before the model can be trained, we need to define a criterion to minimize. Typically, a cross-entropy loss function is used for semantic segmentation. However, because our dataset has a very extreme class imbalance, focal loss is a good approach to alleviate problems that arise when training on unbalanced datasets. <a class="reference external" href="https://arxiv.org/abs/1708.02002">From the paper:</a></p>
<blockquote>
<div><p>“Our novel Focal Loss focuses training on a sparse set of hard examples and prevents the vast number of easy negatives from overwhelming the detector during training.”</p>
</div></blockquote>
<p>More specifically, focal loss adds a modulating factor to the cross entropy loss, such that</p>
<p><span class="math notranslate nohighlight">\( \ell(p_t) = -(1-p_t)^{\gamma} \log{p_t} \)</span>,</p>
<p>where <span class="math notranslate nohighlight">\( p_t = p \)</span>, the model’s estimated probability for the class label when the classification is correct, and <span class="math notranslate nohighlight">\( p_t = 1 - p \)</span> when the classification is incorrect. The presence of the modulating factor <span class="math notranslate nohighlight">\( (1-p_t)^{\gamma} \)</span> forces the model to focus on samples that are harder to classify. This is particularly handy in vision problems, where unbalanced datasets are common. Note that we can also include the class weight term <span class="math notranslate nohighlight">\( \alpha \)</span> into the such that <span class="math notranslate nohighlight">\( \ell(p_t) = - \alpha (1-p_t)^{\gamma} \log{p_t} \)</span> to further assist in training on unbalanced datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># basic focal loss implementation from </span>
<span class="c1"># https://github.com/AdeelH/pytorch-multi-class-focal-loss/blob/master/focal_loss.py</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="k">class</span> <span class="nc">FocalLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Focal Loss, as described in https://arxiv.org/abs/1708.02002.</span>

<span class="sd">    It is essentially an enhancement to cross entropy loss and is</span>
<span class="sd">    useful for classification tasks when there is a large class imbalance.</span>
<span class="sd">    x is expected to contain raw, unnormalized scores for each class.</span>
<span class="sd">    y is expected to contain class labels.</span>

<span class="sd">    Shape:</span>
<span class="sd">        - x: (batch_size, C) or (batch_size, C, d1, d2, ..., dK), K &gt; 0.</span>
<span class="sd">        - y: (batch_size,) or (batch_size, d1, d2, ..., dK), K &gt; 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">        Args:</span>
<span class="sd">            alpha (Tensor, optional): Weights for each class. Defaults to None.</span>
<span class="sd">            gamma (float, optional): A constant, as described in the paper.</span>
<span class="sd">                Defaults to 2.</span>
<span class="sd">            ignore_index (int, optional): class label to ignore.</span>
<span class="sd">                Defaults to -100.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_index</span> <span class="o">=</span> <span class="n">ignore_index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="n">ignore_index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># (N, C, d1, d2, ..., dK) --&gt; (N * d1 * ... * dK, C)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="c1"># (N, d1, d2, ..., dK) --&gt; (N * d1 * ... * dK,)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">unignored_mask</span> <span class="o">=</span> <span class="n">y</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_index</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">unignored_mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">unignored_mask</span><span class="p">]</span>

        <span class="c1"># compute weighted cross entropy term: -alpha * log(pt)</span>
        <span class="c1"># (alpha is already part of self.nll_loss)</span>
        <span class="c1"># print(x.dtype)</span>
        <span class="n">log_p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="c1"># https://discuss.pytorch.org/t/runtimeerror-expected-object-of-scalar-type-long-but-got-scalar-type-float-when-using-crossentropyloss/30542/2</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># get true class column from each row</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">log_pt</span> <span class="o">=</span> <span class="n">log_p</span><span class="p">[</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>

        <span class="c1"># compute focal term: (1 - pt)^gamma</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">log_pt</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="n">focal_term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pt</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>

        <span class="c1"># the full loss: -alpha * ((1 - pt)^gamma) * log(pt)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">focal_term</span> <span class="o">*</span> <span class="n">ce</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># only using mean reduction for simplicity</span>

        <span class="k">return</span> <span class="n">loss</span>

<span class="c1"># quick test of focal loss</span>
<span class="n">X_loss_test</span><span class="p">,</span> <span class="n">y_loss_test</span> <span class="o">=</span> <span class="n">subset_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get first sample in dataset</span>

<span class="c1"># merge impervious classes</span>
<span class="n">y_loss_test</span> <span class="o">=</span> <span class="n">merge_impervious_classes</span><span class="p">(</span><span class="n">y_loss_test</span><span class="p">)</span>

<span class="c1"># need to add batch dimension to input and target</span>
<span class="n">X_loss_test</span> <span class="o">=</span> <span class="n">X_loss_test</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_loss_test</span> <span class="o">=</span> <span class="n">y_loss_test</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">test_loss_fn</span> <span class="o">=</span> <span class="n">FocalLoss</span><span class="p">()</span> <span class="c1"># create loss function object</span>

<span class="n">y_hat_loss_test</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_loss_test</span><span class="p">)</span> <span class="c1"># run inference</span>
<span class="n">test_loss</span> <span class="o">=</span> <span class="n">test_loss_fn</span><span class="p">(</span><span class="n">y_hat_loss_test</span><span class="p">,</span> <span class="n">y_loss_test</span><span class="p">)</span> <span class="c1"># calculate loss</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss: &#39;</span><span class="p">,</span> <span class="n">test_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

<span class="c1"># Visualize inferred image. Will look bad at first, that&#39;s okay</span>
<span class="n">y_raster</span> <span class="o">=</span> <span class="n">y_hat_loss_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="c1"># convert target to numpy array</span>
<span class="n">y_raster</span> <span class="o">=</span> <span class="n">y_raster</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">y_raster</span> <span class="o">=</span> <span class="n">y_raster</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">visualize_target</span><span class="p">(</span><span class="n">y_loss_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
<span class="n">visualize_target</span><span class="p">(</span><span class="n">y_raster</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Predicted (no training)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loss:  1.1566414833068848
</pre></div>
</div>
<img alt="../../_images/d641546ec8bbba3abf6f99b14e9440d21f192d1f166c1aab2b8fd8d1d00e4a7e.png" src="../../_images/d641546ec8bbba3abf6f99b14e9440d21f192d1f166c1aab2b8fd8d1d00e4a7e.png" />
<img alt="../../_images/84f6ade72ae1c26a1da15c439214463f86b0a292385b579e74b41ca3d28a454a.png" src="../../_images/84f6ade72ae1c26a1da15c439214463f86b0a292385b579e74b41ca3d28a454a.png" />
</div>
</div>
<section id="altering-weights-for-the-loss-function">
<h4>Altering weights for the loss function<a class="headerlink" href="#altering-weights-for-the-loss-function" title="Permalink to this heading">#</a></h4>
<p>We want to emphasize the importance of classes that are hard to train in our loss function. We do this by passing weights for each class as the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> parameter to the loss function. Classes with few examples will get a higher weight. We will generate those weights using the following code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">train_class_dist</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># increase exponent to increase weight of underrepresented classes</span>
<span class="c1"># make alpha mean = 1</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">alpha</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.96027595 0.24102336 0.62290542 1.62257376 1.55322151]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="hyperparameters-optimization-and-gpu-acceleration">
<h3>Hyperparameters, optimization, and GPU acceleration<a class="headerlink" href="#hyperparameters-optimization-and-gpu-acceleration" title="Permalink to this heading">#</a></h3>
<p>Now, we can set the hyperparameters, configure our optimizer, and set up GPU acceleration. For simplicity’s sake, we’ll use the Adam optimizer and a batch size of 8. In addition, we’ll use two learning rate schedulers to improve the stability of training - one will be a warmup scheduler that will reduce the learning rate during the first five epochs of training. After five epochs of training, the learning rate will be increased, upon which it will be reduced by a factor of 10 after every five epochs in which validation loss does not improve.</p>
<div class="cell tag_parameters docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.0000001</span> <span class="c1"># learning rate for optimizer - feel free to experiment</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span> <span class="c1"># batch size to use</span>
<span class="n">NUM_EPOCHS</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># number of epochs to train for - will stop early if validation loss stops improving</span>
<span class="n">FL_GAMMA</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="c1"># gamma parameter for focal loss</span>
<span class="n">PATIENCE</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># patience for early stopping</span>
<span class="n">WARMUP_EPOCHS</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># number of epochs for warmup</span>
<span class="n">LR_PATIENCE</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># patience for learning rate scheduler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimizer and loss function setup</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LEARNING_RATE</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">FocalLoss</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="n">FL_GAMMA</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
<span class="n">warmup_scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="p">,</span> 
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">WARMUP_EPOCHS</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># lr reduced by a factor of 100 for first few epochs</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">reduce_lr_scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="n">LR_PATIENCE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># use GPU if avaliable</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># enable CUDNN profiling (faster runtime)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Adjusting learning rate of group 0 to 0.0000e+00.
Using device: cuda
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># move model to GPU if available</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1"># move loss function to GPU if available</span>

<span class="c1"># visualize model architecture + number of trainable parameters</span>
<span class="kn">from</span> <span class="nn">torchinfo</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="n">summary</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>====================================================================================================
Layer (type:depth-idx)                             Output Shape              Param #
====================================================================================================
UNet                                               [16, 5, 256, 256]         --
├─ModuleList: 1-1                                  --                        --
│    └─DoubleConv: 2-1                             [16, 64, 256, 256]        --
│    │    └─Sequential: 3-1                        [16, 64, 256, 256]        39,424
│    └─Down: 2-2                                   [16, 128, 128, 128]       --
│    │    └─Sequential: 3-2                        [16, 128, 128, 128]       221,696
│    └─Down: 2-3                                   [16, 256, 64, 64]         --
│    │    └─Sequential: 3-3                        [16, 256, 64, 64]         885,760
│    └─Down: 2-4                                   [16, 512, 32, 32]         --
│    │    └─Sequential: 3-4                        [16, 512, 32, 32]         3,540,992
│    └─Down: 2-5                                   [16, 1024, 16, 16]        --
│    │    └─Sequential: 3-5                        [16, 1024, 16, 16]        14,159,872
├─ModuleList: 1-2                                  --                        --
│    └─Up: 2-6                                     [16, 512, 32, 32]         --
│    │    └─ConvTranspose2d: 3-6                   [16, 512, 32, 32]         2,097,664
│    │    └─DoubleConv: 3-7                        [16, 512, 32, 32]         7,079,936
│    └─Up: 2-7                                     [16, 256, 64, 64]         --
│    │    └─ConvTranspose2d: 3-8                   [16, 256, 64, 64]         524,544
│    │    └─DoubleConv: 3-9                        [16, 256, 64, 64]         1,770,496
│    └─Up: 2-8                                     [16, 128, 128, 128]       --
│    │    └─ConvTranspose2d: 3-10                  [16, 128, 128, 128]       131,200
│    │    └─DoubleConv: 3-11                       [16, 128, 128, 128]       442,880
│    └─Up: 2-9                                     [16, 64, 256, 256]        --
│    │    └─ConvTranspose2d: 3-12                  [16, 64, 256, 256]        32,832
│    │    └─DoubleConv: 3-13                       [16, 64, 256, 256]        110,848
├─OutConv: 1-3                                     [16, 5, 256, 256]         --
│    └─Conv2d: 2-10                                [16, 5, 256, 256]         325
====================================================================================================
Total params: 31,038,469
Trainable params: 31,038,469
Non-trainable params: 0
Total mult-adds (G): 874.76
====================================================================================================
Input size (MB): 16.78
Forward/backward pass size (MB): 9235.86
Params size (MB): 124.15
Estimated Total Size (MB): 9376.79
====================================================================================================
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1"># ignore warnings for all cells below</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-black-dataloader-span">
<h3><span style="color:black;">DataLoader</span><a class="headerlink" href="#span-style-color-black-dataloader-span" title="Permalink to this heading">#</a></h3>
<p>PyTorch uses the DataLoader class to select and batch samples during training. Because we are using a validation set as well as a training set,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="c1"># for progress bars</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span> <span class="c1"># for clearing output in jupyter notebook</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span> <span class="c1"># we will use these to keep track of model performance during training, more on this later</span>

<span class="c1"># save loss values for plotting</span>
<span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">precision_scores</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">recall_scores</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># only want to save the model with the best validation loss</span>
<span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="c1"># set best validation loss to infinity to start</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_EPOCHS</span><span class="p">):</span>

    <span class="c1"># train step</span>
    <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span> <span class="c1"># set model to train mode (enables autograd and dropout)</span>
    <span class="n">train_batch_losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">NUM_EPOCHS</span><span class="si">}</span><span class="s1"> train step&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t_train</span><span class="p">:</span> <span class="c1"># create a progress bar for training</span>
        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">t_train</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># reset gradients to 0 (PyTorch does not do this automatically</span>
            <span class="c1"># move data to GPU if available</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            
            <span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">train_batch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">running_train_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">train_batch_losses</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_batch_losses</span><span class="p">)</span>
            <span class="n">epoch_train_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="c1"># add total batch loss to epoch loss</span>
            <span class="n">t_train</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">running_train_loss</span><span class="p">)</span>
            
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># backpropagate loss</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> <span class="c1"># update optimizer parameters (lr, momentum, etc.)</span>
    
    <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_train_loss</span><span class="p">)</span> <span class="c1"># calculate average loss for epoch and append to list</span>
    
    <span class="c1"># validation step</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="c1"># set model to eval mode (disables autograd and dropout)</span>
    <span class="n">val_batch_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">running_precision_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">running_recall_scores</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">NUM_EPOCHS</span><span class="si">}</span><span class="s1"> val step&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t_val</span><span class="p">:</span> <span class="c1"># create a progress bar for validation</span>
        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">t_val</span><span class="p">:</span>
            <span class="c1"># move data to GPU if available</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            
            <span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">val_batch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">running_val_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">val_batch_losses</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_batch_losses</span><span class="p">)</span>
            <span class="n">t_val</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">val_loss</span><span class="o">=</span><span class="n">running_val_loss</span><span class="p">)</span>
            
            <span class="c1"># convert y and y_hat from torch tensors to numpy arrays and flatten</span>
            <span class="n">y_cpu</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">y_hat_cpu</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># argmax to convert from class confidence to class index</span>
            
            <span class="n">running_recall_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_cpu</span><span class="p">,</span> <span class="n">y_hat_cpu</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">))</span>
            <span class="n">running_precision_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_cpu</span><span class="p">,</span> <span class="n">y_hat_cpu</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">))</span>
    
    <span class="n">val_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_val_loss</span><span class="p">)</span> <span class="c1"># calculate average loss for epoch and append to list</span>
    
    <span class="n">recall_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">running_recall_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_recall_scores</span><span class="p">))</span>
    <span class="n">precision_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">running_precision_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_precision_scores</span><span class="p">))</span>
    
    <span class="c1"># update best validation loss and save model if new best is found</span>
    <span class="k">if</span> <span class="n">val_losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
        <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;./best_model.pth&#39;</span><span class="p">)</span>
        
    <span class="c1"># plot training curves</span>
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># clear output before plotting</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="c1"># create figure. will contain loss/accuracy curves</span>
    
    <span class="c1"># loss curve (ax1 - left y axis)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Training Curves&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation Loss&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Focal Loss (mean)&#39;</span><span class="p">)</span>

    <span class="c1"># determine left y axis range from min/max loss values</span>
    <span class="n">y_ax1_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">train_losses</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">val_losses</span><span class="p">))</span> <span class="c1"># find lowest loss value across both curves</span>
    <span class="n">y_ax1_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_ax1_min</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># add some padding to the bottom of the plot. lower bound can&#39;t be less than 0</span>

    <span class="n">y_ax1_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">train_losses</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">val_losses</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="c1"># find highest loss value across both curves, add some padding to the top of the plot</span>

    <span class="c1"># set y axis limits</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_ax1_min</span><span class="p">,</span> <span class="n">y_ax1_max</span><span class="p">)</span>

    <span class="c1"># add veritcal line for best epoch</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">y_ax1_max</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;best epoch=</span><span class="si">{</span><span class="n">best_epoch</span><span class="si">}</span><span class="se">\n</span><span class="s1">val loss=</span><span class="si">{</span><span class="n">best_val_loss</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># add legend</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span> <span class="c1"># put next to upper left corner of plot</span>

    <span class="c1"># create right y axis for precision/recall curves</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

    <span class="c1"># plot precision/recall curves</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">precision_scores</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Precision/UA</span><span class="se">\n</span><span class="si">{</span><span class="n">precision_scores</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">best_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recall_scores</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Recall/PA</span><span class="se">\n</span><span class="si">{</span><span class="n">recall_scores</span><span class="p">[</span><span class="n">best_epoch</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">best_epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Precision/Recall (mean)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># set y axis limits to 0-1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span> <span class="c1"># put legend in upper right corner of plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1"># show plot</span>
    
    <span class="c1"># show example prediction</span>
    <span class="n">y_hat_plot</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># convert target to numpy array\</span>
    <span class="n">y_hat_plot</span> <span class="o">=</span> <span class="n">y_hat_plot</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">visualize_raster</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Input Raster&#39;</span><span class="p">)</span>
    <span class="n">visualize_target</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
    <span class="n">visualize_target</span><span class="p">(</span><span class="n">y_hat_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Inference at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># early stopping</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">-</span> <span class="n">best_epoch</span> <span class="o">&gt;</span> <span class="n">PATIENCE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation loss has not improved for </span><span class="si">{</span><span class="n">PATIENCE</span><span class="si">}</span><span class="s1"> epochs. Stopping early at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">break</span>
    
    <span class="c1"># finally, update schedulers</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">WARMUP_EPOCHS</span><span class="p">:</span> <span class="c1"># if still in warmup phase</span>
        <span class="n">warmup_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reduce_lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1eff35dd0ad416eb390a02d86e3e4ea7151b9cc3ef26d220104609e967954ce5.png" src="../../_images/1eff35dd0ad416eb390a02d86e3e4ea7151b9cc3ef26d220104609e967954ce5.png" />
<img alt="../../_images/1c072cc82631bc19c93397fddf73977399d50099a54f6090285275025c2de9ec.png" src="../../_images/1c072cc82631bc19c93397fddf73977399d50099a54f6090285275025c2de9ec.png" />
<img alt="../../_images/d245e13f5c7cb1d1e2a2783e1d1c47e738236afd4ee2fcbc6cd1d44a1237965b.png" src="../../_images/d245e13f5c7cb1d1e2a2783e1d1c47e738236afd4ee2fcbc6cd1d44a1237965b.png" />
<img alt="../../_images/76b6958fcf9e18aa1e6b7bdb850218f5040089cadc816011be0ce5d55fa0fe88.png" src="../../_images/76b6958fcf9e18aa1e6b7bdb850218f5040089cadc816011be0ce5d55fa0fe88.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Validation loss has not improved for 20 epochs. Stopping early at epoch 146
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-black-evaluation-span">
<h2><span style="color:black;">Evaluation</span><a class="headerlink" href="#span-style-color-black-evaluation-span" title="Permalink to this heading">#</a></h2>
<p>Now that the model has been trained, the final (and most important) step is to determine the model’s performance by performing inference on an annotated holdout “test” set.</p>
</section>
<section id="span-style-color-black-metrics-span">
<h2><span style="color:black;">Metrics</span><a class="headerlink" href="#span-style-color-black-metrics-span" title="Permalink to this heading">#</a></h2>
<p>The simplest way to construct metrics on a per-class basis is to first count the number of true positives, false positives, true negatives, and false negatives by comparing the ground truth data and the models predictions. For enhanced accuracy, we can do this on a per-class basis.</p>
<blockquote>
<div><p>True Positives (<span class="math notranslate nohighlight">\( TP \)</span>): positive prediction is correct - (<span class="math notranslate nohighlight">\( \hat{y} = 1; y = 1 \)</span>)</p>
<p>False Positives/type I error (<span class="math notranslate nohighlight">\( FP \)</span>): positive prediction is incorrect - (<span class="math notranslate nohighlight">\( \hat{y} = 1; y = 0 \)</span>)</p>
<p>True Negatives (<span class="math notranslate nohighlight">\( TN \)</span>): negative prediction is correct - (<span class="math notranslate nohighlight">\( \hat{y} = 0; y = 0 \)</span>)</p>
<p>False Negative/type II error (<span class="math notranslate nohighlight">\( FN \)</span>): negative prediction is incorrect - (<span class="math notranslate nohighlight">\( \hat{y} = 0; y = 1 \)</span>)</p>
</div></blockquote>
<p>Next, using these values, we can construct accuracy metrics:</p>
<blockquote>
<div><p>Accuracy: ratio of correct predictions to the total number of predictions (<span class="math notranslate nohighlight">\( ACC = \frac{TP + TN}{TP + FP + TN + FN} \)</span>)</p>
<p>User’s accuracy/precision: ratio of total number of true positives to true positives and false positives (<span class="math notranslate nohighlight">\( UA = \frac{TP}{TP + FP} \)</span>)</p>
<p>Producer’s accuracy/recall: ratio of total number of true positives to true positives and false negatives (<span class="math notranslate nohighlight">\( PA = \frac{TP}{TP + FN} \)</span>)</p>
<p>Intersection over Union (IoU): ratio of true positives to true positives, false positives, and false negatives (<span class="math notranslate nohighlight">\(IoU = \frac{TP}{TP + FP + FN} \)</span>) - we won’t use this one, but it</p>
<p>F1-score: harmonic mean of user’s accuracy and producer’s accuracy - commonly referred to as precision and recall, respectively (<span class="math notranslate nohighlight">\(F1 = \frac{2 \cdot UA \cdot PA}{UA + PA}\)</span>)</p>
</div></blockquote>
<p>Typically, a good model will have similar results for both producer’s and user’s accuracy - large differences between PA and UA typically indicates the model is biased towards certain classes. IoU is a good metric for determining how well the model can discriminate between foreground regions and background regions, though we will not implement it here.</p>
<p>Thankfully, sklearn has a <code class="docutils literal notranslate"><span class="pre">classification_report</span></code> function that can generate these precision, recall, and f1 scores on a per-class basis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>

<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="n">y_hats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

<span class="c1"># load the best model</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_model.pth&#39;</span><span class="p">))</span>

<span class="c1"># look at class distribution of test set</span>
<span class="n">test_class_dist</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">get_class_distribution</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_class_dist</span><span class="p">)</span>

<span class="c1"># find nuber of samples in each class</span>
<span class="n">test_class_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">test_class_dist</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">224</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_class_samples</span><span class="p">)</span>

<span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Test step&#39;</span><span class="p">):</span>
    <span class="c1"># move data to GPU if available</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">y_hat</span> <span class="o">=</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># convert from one-hot to class index</span>
    
    <span class="c1"># cppend batch results to numpy arrays</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">y_hats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_hats</span><span class="p">,</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

<span class="n">cr</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">y_hats</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">target_names</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2.23006232e-01 6.13281165e-01 3.91751534e-01 5.47302392e-04
 2.14137672e-02]
[13785539 37911099 24216839    33833  1323731]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test step: 100%|██████████| 77/77 [00:32&lt;00:00,  2.35batch/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                      precision    recall  f1-score   support

               Water       0.94      0.95      0.94  11028431
  Tree Canopy/Forest       0.96      0.84      0.90  30328879
Low Vegetation/Field       0.78      0.93      0.85  19373471
         Barren Land       0.00      0.00      0.00     27066
         Imperivious       0.54      0.56      0.55   1058985

            accuracy                           0.88  61816832
           macro avg       0.64      0.66      0.65  61816832
        weighted avg       0.89      0.88      0.88  61816832
</pre></div>
</div>
</div>
</div>
<p>Overall, the results are mixed. The model excels at classifying water, tree canopy, and low vegetation (to a lesser extent), but is poor at classifying barren land and impervious classes. One reason for the poor performance on both the barren land and impervious classes is the lack of support for those classes in the training and testing dataset. Recall earlier that this dataset is extremely unbalanced. In order to boost the performance the barren land and impervious classes, we would need to source more samples that contain those classes.</p>
<section id="span-style-color-black-confusion-matrix-span">
<h3><span style="color:black;">Confusion matrix</span><a class="headerlink" href="#span-style-color-black-confusion-matrix-span" title="Permalink to this heading">#</a></h3>
<p>To get a better idea of how the model is classifying based on the input data, we can generate a confusion matrix. Confusion matrices show the difference between the ground truth data and the model’s inferences on a class-by-class basis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">classification_report</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">y_hats</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">disp</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="n">land_cover_labels</span><span class="p">)</span>
<span class="n">disp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xticks_rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay at 0x255b962fee0&gt;
</pre></div>
</div>
<img alt="../../_images/277863dc61922bc93bafdc5646a80f81b759c524315b3559ba3d88405d2eb0df.png" src="../../_images/277863dc61922bc93bafdc5646a80f81b759c524315b3559ba3d88405d2eb0df.png" />
</div>
</div>
<p>The model obviously struggles with classifying impervious and barren land classes, most likely due to the lack of samples in the dataset.</p>
</section>
<section id="span-style-color-black-visual-analysis-span">
<h3><span style="color:black;">Visual analysis</span><a class="headerlink" href="#span-style-color-black-visual-analysis-span" title="Permalink to this heading">#</a></h3>
<p>Finally, let’s look at some example predictions on the hold-out data to make sure our model’s inferences look accurate, since metrics only give us part of the story.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># final visual anaylysis</span>

<span class="c1"># create subplots for each raster, ground truth, and prediction</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RGB Raster&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CIR Raster&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
    
    <span class="c1"># use sample from final batch of test loader</span>
    <span class="n">raster</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># convert to numpy array</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    
    <span class="n">rgb_raster</span> <span class="o">=</span> <span class="n">raster</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># get RGB channels</span>
    <span class="n">cir_raster</span> <span class="o">=</span> <span class="n">raster</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="c1"># get CIR channels</span>
    
    <span class="c1"># transpose to (H, W, C) for matplotlib</span>
    <span class="n">rgb_raster</span> <span class="o">=</span> <span class="n">rgb_raster</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cir_raster</span> <span class="o">=</span> <span class="n">cir_raster</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># squeeze to remove extra dimension</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="c1"># plot</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb_raster</span><span class="p">)</span> 
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cir_raster</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">land_cover_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">land_cover_cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="c1"># remove axis ticks and labels</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
<span class="c1"># add land cover legend</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">land_cover_legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9d688c064fd744d9b894d548f6409cc18f77879fc5ab32d2d90211fc13cb78a9.png" src="../../_images/9d688c064fd744d9b894d548f6409cc18f77879fc5ab32d2d90211fc13cb78a9.png" />
</div>
</div>
<p>Overall, the inferences are not terrible. While the model’s predictions are not perfect (it particularly struggles with barren land), the ground truth samples are not 100% accurate either.</p>
<p>All in all, the model did not perform exceptionally well, but it can classify water, forest, and low vegetation fairly accurately. There are some tweaks we can make to improve the performance of our model.</p>
<ul class="simple">
<li><p>Use a higher quality (preferably hand-annotated) dataset.</p></li>
<li><p>Selectively sample to reduce class imbalance</p></li>
<li><p>Use a deeper/more powerful model (such as DeepLabv3+)</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs\deeplearning"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../gdal/gdal_misc.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span style="color:black;">GDAL programs</span></p>
      </div>
    </a>
    <a class="right-next"
       href="ndvi_time_series.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span style="color:black;">Crop Time series Xarray</span></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-overview-span"><span style="color:black;">Overview</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-data-sources-span"><span style="color:black;">Data sources</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-loading-data-span"><span style="color:black;">Loading data</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-finding-files-span"><span style="color:black;">Finding files</span></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#merging-impervious-classes">Merging impervious classes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-train-test-val-splits">Creating train/test/val splits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-dataset-class">Creating a Dataset class</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#image-transforms-rotate-and-flip">Image Transforms (Rotate and Flip)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-all-together">Putting it all together</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-building">Model building</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-u-net">Defining U-Net</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-our-model">Testing our model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-the-model">Training the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-loss-function-focal-loss">Defining a loss function (focal loss)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#altering-weights-for-the-loss-function">Altering weights for the loss function</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperparameters-optimization-and-gpu-acceleration">Hyperparameters, optimization, and GPU acceleration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-dataloader-span"><span style="color:black;">DataLoader</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-evaluation-span"><span style="color:black;">Evaluation</span></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-metrics-span"><span style="color:black;">Metrics</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-confusion-matrix-span"><span style="color:black;">Confusion matrix</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#span-style-color-black-visual-analysis-span"><span style="color:black;">Visual analysis</span></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Vitor Martins, Dakota Hester, Lucas Ferreira, Uilson Aires
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>